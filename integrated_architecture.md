# 統合アーキテクチャ: LLM統合型ソースコード分析システム

*バージョン: v3.1.0*
*最終更新: 2025年01月27日 16:30 JST*

## システム全体像

```
┌─────────────────────────────────────────────────────────────────┐
│                    ソースコードリポジトリ                          │
│              (Java/TS/Angular/Go/C# - 35,000ファイル)            │
│     DB: Cassandra, Elasticsearch, Redis, MySQL, SQL Server      │
└────────────────────────┬────────────────────────────────────────┘
                         │
                         ▼
┌─────────────────────────────────────────────────────────────────┐
│                  並列解析オーケストレーター                        │
│                    (Celery + RabbitMQ)                           │
└────────────┬────────────────────────────────────┬───────────────┘
             │                                    │
             ▼                                    ▼
┌────────────────────────┐           ┌────────────────────────┐
│   静的解析レイヤー       │           │   LLM分析レイヤー       │
│   (高速・確実)          │           │   (深い理解・柔軟)      │
├────────────────────────┤           ├────────────────────────┤
│ • 言語パーサー          │           │ • Claude Sonnet 4.5    │
│ • AST解析              │           │ • GPT-5 Codex          │
│ • データフロー分析      │           │ • 意味的理解           │
│ • CQL解析              │           │ • コンテキスト推論      │
│ • 依存関係抽出          │           │ • 修正案生成           │
└────────────┬───────────┘           └────────────┬───────────┘
             │                                    │
             └────────────┬───────────────────────┘
                          ▼
              ┌───────────────────────┐
              │  統合判定レイヤー       │
              │  - 信頼度計算          │
              │  - 結果マージ          │
              │  - 優先度付け          │
              └───────────┬───────────┘
                          ▼
              ┌───────────────────────┐
              │   Neo4j グラフDB       │
              │   - コード関係性        │
              │   - DB操作履歴         │
              │   - 分析結果           │
              └───────────┬───────────┘
                          ▼
    ┌─────────────────────┴─────────────────────┐
    │                                            │
    ▼                                            ▼
┌──────────────────┐                  ┌──────────────────┐
│  API レイヤー     │                  │  自動化レイヤー   │
│  (FastAPI)       │                  │                  │
│  • 影響範囲分析   │                  │  • 自動修正       │
│  • 問題検出       │                  │  • PR生成        │
│  • データモデル評価│                  │  • レポート生成   │
└────────┬─────────┘                  └────────┬─────────┘
         │                                      │
         └──────────────┬───────────────────────┘
                        ▼
         ┌────────────────────────┐
         │   可視化レイヤー        │
         │   (React + D3.js)      │
         ├────────────────────────┤
         │ • ダッシュボード        │
         │ • グラフビュー          │
         │ • レポート             │
         │ • 修正提案UI           │
         └────────────────────────┘
```

---

## 4つの仕様書の役割分担

### 📄 仕様書1: メイン仕様書 (ソースコード関係性分析)
**役割**: システムの基盤
- 35,000ファイルの解析基盤
- 5言語対応 (Java/TS/Angular/Go/C#)
- Neo4jデータモデル
- 基本的な依存関係分析

**重要なコンポーネント**:
- 言語別パーサー
- 並列処理基盤 (Celery)
- グラフDB設計
- 影響範囲分析アルゴリズム

---

### 📄 仕様書2: DB拡張仕様書 (データベース特化)
**役割**: データベース横断的な問題検出
- 5種のDB対応 (Cassandra/ES/Redis/MySQL/SQL Server)
- N+1問題検出
- トランザクション管理
- キャッシュ整合性

**重要なコンポーネント**:
- SQL/CQLパーサー
- トランザクション追跡
- キャッシュ操作分析
- クロスDB整合性チェック

---

### 📄 仕様書3: Cassandra特化仕様書
**役割**: Cassandra深堀り分析（最優先実装）
- Consistency Level追跡
- Partition Key検証
- データモデル評価
- パフォーマンス予測

**重要なコンポーネント**:
- CQL詳細解析
- 整合性レベル追跡
- ホットパーティション検出
- テーブル変更影響分析

---

### 📄 仕様書4: LLMハイブリッド仕様書
**役割**: 静的解析の限界を超える
- 意味的な問題検出
- ビジネスロジック検証
- 自動修正提案
- 自然言語レポート生成

**重要なコンポーネント**:
- LLMクライアント (Claude/GPT-5)
- ハイブリッド分析エンジン
- 信頼度計算
- コスト最適化

---

## データフロー

```
1. コード変更検出
   └─> Git Hook / CI/CD トリガー

2. ファイル分類
   ├─> 言語判定
   ├─> 重要度評価 (Tier 1-3)
   └─> DB関連判定

3. 静的解析 (全ファイル)
   ├─> 構文解析
   ├─> 依存関係抽出
   ├─> DB操作検出
   └─> 基本的な問題検出

4. LLM分析 (選択的)
   ├─> 重要ファイル (Tier 3)
   ├─> 低信頼度の問題
   └─> Cassandra関連コード

5. 統合判定
   ├─> 信頼度計算
   ├─> 結果マージ
   └─> 優先度付け

6. Neo4jへ保存
   └─> グラフ更新

7. 通知・レポート
   ├─> Slack通知 (Critical)
   ├─> PR自動コメント
   ├─> ダッシュボード更新
   └─> 週次レポート生成
```

---

## 実装の優先順位

### 🔴 Phase 1: Cassandra特化プロトタイプ (Week 1-2)
**目標**: 即座に価値を実証

```
スコープ:
├─ Cassandra DAOファイル 10-20個
├─ 静的CQL解析
├─ ALLOW FILTERING検出
├─ Partition Key未使用検出
└─ HTMLレポート出力

成果物:
└─ 実際のバグ検出デモ
```

### 🟡 Phase 2: LLM統合 (Week 3-4)
**目標**: 深い分析の実現

```
スコープ:
├─ Claude Sonnet 4.5統合
├─ データモデル評価
├─ Consistency Level分析
├─ 修正提案生成
└─ コスト管理

成果物:
└─ LLM分析結果 + 自動修正案
```

### 🟢 Phase 3: 本格展開 (Week 5-10)
**目標**: 全体システムの構築

```
スコープ:
├─ 全Cassandraコード分析
├─ Neo4jグラフDB統合
├─ ダッシュボード構築
├─ CI/CD統合
└─ 週次レポート自動化

成果物:
└─ 本番運用開始
```

### 🔵 Phase 4: 他DB展開 (Week 11-16)
**目標**: 全DBカバー

```
スコープ:
├─ MySQL分析
├─ Redis分析
├─ Elasticsearch分析
└─ SQL Server分析

成果物:
└─ 全DB対応完了
```

---

## コスト試算

### LLM使用コスト (Claude Sonnet 4.5)

| 項目 | 想定 | 月間コスト |
|-----|------|-----------|
| ファイル数 | 35,000ファイル | - |
| Tier 3 (重要) | 3,500ファイル (10%) | $175 |
| Tier 2 (条件付き) | 7,000ファイル (20%) | $140 |
| Tier 1 (静的のみ) | 24,500ファイル (70%) | $0 |
| **月間合計** | - | **$315** |

**想定**: 
- 1ファイルあたり平均$0.05
- 月1回のフルスキャン
- 増分解析は日次

### インフラコスト

| 項目 | スペック | 月間コスト |
|-----|---------|-----------|
| Neo4j | 16GB RAM, 500GB SSD | $300 |
| Celery Workers | 8 instances, 4GB each | $200 |
| RabbitMQ | 4GB RAM | $50 |
| Redis | 8GB RAM | $40 |
| API Server | 8GB RAM | $80 |
| **月間合計** | - | **$670** |

### 総コスト
- LLM: $315/月
- インフラ: $670/月
- **合計: $985/月 ≒ $12,000/年**

### ROI試算

**期待される効果**:
- バグ検出時間: 90%短縮 (1時間 → 6分)
- 本番障害: 80%削減
- 開発者1人あたり: 週5時間の節約

**節約される人件費**:
- 開発者10人 × 週5時間 × 52週 = 2,600時間/年
- 時給$50として = **$130,000/年**

**ROI: ($130,000 - $12,000) / $12,000 = 983%**

---

## 成功の定義

### 技術指標

| 指標 | 目標 | 現状 |
|-----|------|------|
| Cassandraバグ検出率 | > 90% | - |
| 誤検出率 | < 10% | - |
| 分析速度 (35,000ファイル) | < 2時間 | - |
| LLM精度 | > 85% | - |
| システム稼働率 | > 99.5% | - |

### ビジネス指標

| 指標 | 目標 | 現状 |
|-----|------|------|
| 本番障害削減 | 80% | - |
| バグ調査時間短縮 | 90% | - |
| 開発生産性向上 | 20% | - |
| コードレビュー効率 | 50%向上 | - |

---

## 次のアクション

### 即座に決定が必要な事項

1. **Phase 1開始の承認**
   - 2週間プロトタイプの実施
   - 対象ファイルの選定
   - 評価基準の設定

2. **LLMプロバイダーの選択**
   - Claude Sonnet 4.5を推奨
   - APIキーの取得
   - 月間予算の承認 ($315/月)

3. **リソースの確保**
   - 開発担当者のアサイン
   - インフラ環境の準備
   - レビュー担当者の選定

4. **成功基準の合意**
   - Phase 1で検出すべきバグ数
   - 許容される誤検出率
   - 次フェーズへの移行条件

### 準備できること

確認をお待ちする間に、以下を準備可能です:

- [ ] Docker Compose環境構築
- [ ] Neo4jスキーマ設計
- [ ] サンプルコードでの動作検証
- [ ] コスト管理ツールの実装
- [ ] ドキュメント整備

---

## まとめ

本システムは**4つのレイヤー**で構成されます:

1. **基盤レイヤー** (仕様書1): 35,000ファイルの解析基盤
2. **DB特化レイヤー** (仕様書2-3): Cassandraを中心としたDB分析
3. **知能レイヤー** (仕様書4): LLMによる深い理解と自動修正
4. **価値提供レイヤー**: ダッシュボード、レポート、自動化

この4層アーキテクチャにより、**静的解析の確実性**と**LLMの柔軟性**を両立し、
従来不可能だったレベルのコード品質管理を実現します。

**投資対効果**: 年間$12,000の投資で$130,000の人件費削減 → **ROI 983%**

---

---

*最終更新: 2025年01月27日 16:30 JST*
*バージョン: v3.1.0*

**更新履歴:**
- v3.1.0 (2025年01月27日): プロジェクト構造更新に伴うドキュメント整合性確保
- v3.0.0 (2025年01月26日): 統合アーキテクチャ策定
