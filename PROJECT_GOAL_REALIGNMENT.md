# プロジェクトゴール再定義文書

**作成日**: 2025年10月27日
**バージョン**: v1.0.0
**重要度**: 🔴 Critical

---

## 🎯 プロジェクトの真のゴール

### 本質的な目的

**「ソースファイルの関連情報を可視化し、バグ箇所を特定しやすくするシステム」**

### 具体的なユースケース

#### 1. バグ影響範囲の即時特定
```
シナリオ: 本番環境でバグが発生
従来: 1時間かけてコードを追跡 → 影響範囲を特定
本システム: 10秒でグラフ可視化 → 影響を受けるファイル一覧を表示
```

#### 2. モジュール間の関係性理解
```
質問: 「UserService.java は何のモジュールを使っているか？」
本システムの回答:
  - DatabaseModule (MySQL接続)
  - CacheModule (Redis)
  - LoggingModule
  - ValidationModule

視覚的にグラフで表示 → 依存関係が一目瞭然
```

#### 3. リファクタリング影響分析
```
タスク: AuthenticationService をリファクタリング
本システム:
  1. 依存している47個のファイルを列挙
  2. 影響を受けるメソッド183個を表示
  3. テストすべき箇所をハイライト
  4. リスク評価 (High/Medium/Low)
```

#### 4. バグ原因箇所の特定
```
問題: データが時々消える
分析フロー:
  1. データ保存処理 → どのファイルが呼んでいるか追跡
  2. トランザクション境界を確認
  3. 例外ハンドリング箇所を特定
  4. 根本原因: ErrorHandlerで例外を握りつぶしている

本システム: グラフを辿って5分で原因特定
従来: 1日かけてコード検索
```

---

## 🏗️ 4層アーキテクチャ

### Layer 1: 基盤レイヤー（Phase 1-2完了✅）
**役割**: ソースコードの構造解析

```
実装内容:
├─ Java/TypeScript/Go/C# パーサー
├─ AST (抽象構文木) 解析
├─ import/include文の抽出
├─ 関数/メソッド呼び出しの検出
└─ クラス継承関係の解析

成果物:
└─ 35,000ファイルの構造データ
```

### Layer 2: グラフDBレイヤー（Phase 3完了✅）
**役割**: 関係性のグラフ化と保存

```
実装内容:
├─ Neo4jスキーマ設計
│   ├─ File ノード
│   ├─ Class ノード
│   ├─ Method ノード
│   ├─ DEPENDS_ON エッジ
│   ├─ CALLS エッジ
│   └─ INHERITS エッジ
├─ グラフデータのインポート
├─ Cypherクエリ最適化
└─ インデックス設計

成果物:
└─ 関係性グラフDB (検索可能な状態)
```

### Layer 3: 可視化・分析レイヤー（Phase 4で実装すべき！）
**役割**: ユーザーへの価値提供

```
実装すべき内容:
┌────────────────────────────────────────┐
│ A. Reactダッシュボード                  │
├────────────────────────────────────────┤
│  1. ファイル検索UI                      │
│  2. 依存関係グラフ表示 (D3.js)          │
│  3. 影響範囲分析ビュー                  │
│  4. バグ特定支援ツール                  │
│  5. リファクタリング影響分析            │
└────────────────────────────────────────┘

┌────────────────────────────────────────┐
│ B. 影響範囲分析API (FastAPI)           │
├────────────────────────────────────────┤
│  POST /api/impact-analysis             │
│    → 指定ファイルの影響範囲を返す      │
│                                        │
│  POST /api/refactoring-risk            │
│    → リファクタリングのリスク評価      │
│                                        │
│  GET /api/dependencies/{file_path}     │
│    → ファイルの依存関係を取得          │
└────────────────────────────────────────┘

┌────────────────────────────────────────┐
│ C. グラフ可視化コンポーネント           │
├────────────────────────────────────────┤
│  - インタラクティブなノード表示        │
│  - ズーム/パン操作                     │
│  - フィルタリング (言語/モジュール別)  │
│  - ハイライト (影響範囲を色分け)       │
│  - パスファインダー (2つのノード間)    │
└────────────────────────────────────────┘
```

### Layer 4: 補完機能レイヤー（Phase 4以降）
**役割**: より深い分析

```
拡張機能 (現在のphase4_multidbの内容):
├─ データベース操作分析
│   ├─ N+1問題検出
│   ├─ トランザクション分析
│   └─ キャッシュ操作分析
├─ LLM統合
│   ├─ 意味的な問題検出
│   └─ 自動修正提案
└─ その他の静的解析強化
```

---

## 🔄 現状の齟齬と修正計画

### 問題点

現在のPhase 4実装は「Layer 4: 補完機能」を先に実装してしまった。
しかし、**Layer 3: 可視化・分析レイヤー**が未実装のため、ユーザーに価値を提供できていない。

### 修正計画

#### ステップ1: 現在の実装を再配置
```bash
# 現在のphase4_multidb → 補完機能として保管
mv phase4_multidb/ phase4_database_extension/

# または
mv phase4_multidb/ extensions/database_analysis/
```

#### ステップ2: 正しいPhase 4の仕様書作成
```
新規作成:
└─ PHASE4_VISUALIZATION_SPEC.md
    ├─ Reactダッシュボード設計
    ├─ D3.jsグラフコンポーネント
    ├─ 影響範囲分析API
    ├─ UI/UXデザイン
    └─ 実装計画
```

#### ステップ3: 新しいphase4_visualization実装
```
phase4_visualization/
├── frontend/                    # React + TypeScript
│   ├── src/
│   │   ├── components/
│   │   │   ├── GraphView/      # D3.jsグラフ表示
│   │   │   ├── ImpactAnalysis/ # 影響範囲分析UI
│   │   │   ├── FileExplorer/   # ファイル検索
│   │   │   └── Dashboard/      # メインダッシュボード
│   │   ├── api/                # API クライアント
│   │   └── hooks/              # Reactフック
├── backend/                     # FastAPI
│   ├── api/
│   │   ├── impact_analysis.py
│   │   ├── graph_query.py
│   │   └── refactoring_risk.py
│   └── neo4j_client.py
└── README.md
```

---

## 📋 新しいTODOリスト

### Phase 4: 可視化・影響範囲分析レイヤー（正しい方向性）

#### Week 1-2: バックエンドAPI実装
- [ ] FastAPI影響範囲分析エンドポイント
  - [ ] POST /api/impact-analysis
  - [ ] POST /api/refactoring-risk
  - [ ] GET /api/dependencies/{file_path}
  - [ ] GET /api/graph/neighbors/{node_id}
- [ ] Neo4jクエリ最適化
  - [ ] 影響範囲のCypherクエリ
  - [ ] パスファインディングクエリ
  - [ ] 循環依存検出クエリ

#### Week 3-4: フロントエンド基盤
- [ ] React + TypeScript プロジェクトセットアップ
- [ ] D3.jsグラフコンポーネント
  - [ ] ノード/エッジのレンダリング
  - [ ] ズーム/パン操作
  - [ ] インタラクティブ性
- [ ] ファイル検索UI
- [ ] API統合

#### Week 5-6: コア機能実装
- [ ] 影響範囲分析ビュー
  - [ ] ファイル選択 → 依存先/依存元を可視化
  - [ ] 影響度の色分け表示
  - [ ] 影響を受けるファイル一覧
- [ ] バグ特定支援ツール
  - [ ] エラーログからファイルを特定
  - [ ] 関連コードを自動追跡
- [ ] リファクタリング影響分析
  - [ ] リスク評価 (High/Medium/Low)
  - [ ] 影響範囲の定量化

#### Week 7-8: UX改善・テスト
- [ ] パフォーマンス最適化
- [ ] ユーザビリティテスト
- [ ] E2Eテスト
- [ ] ドキュメント作成

---

## 🎯 成功の定義

### 技術指標
- [ ] 35,000ファイルのグラフを10秒以内に表示
- [ ] 影響範囲分析APIのレスポンス < 2秒
- [ ] フロントエンドの初回ロード < 3秒
- [ ] グラフ操作の滑らかさ (60fps)

### ビジネス指標
- [ ] バグ調査時間: 90%短縮 (1時間 → 6分)
- [ ] リファクタリング計画時間: 80%短縮
- [ ] コードレビュー時間: 50%短縮
- [ ] 開発者満足度: > 8.0/10

---

## 🔑 重要な原則

### 1. ユーザー中心設計
すべての機能は「開発者が何を知りたいか」から逆算して設計する。

### 2. 直感的なUI
技術的な知識がなくても、依存関係を理解できるビジュアル。

### 3. 高速なレスポンス
待たせない。すべての操作は数秒以内に完了。

### 4. 段階的な詳細表示
最初は概要、クリックで詳細 → 情報の階層化。

---

## 📚 参考アーキテクチャ

類似システム:
- GitHub Dependency Graph
- SonarQube Code Analysis
- JetBrains Structure View
- Visual Studio Code Map

本システムの差別化:
- **マルチ言語対応** (5言語)
- **大規模対応** (35,000ファイル)
- **リアルタイム分析**
- **カスタマイズ可能なグラフ表示**

---

## ✅ まとめ

**プロジェクトの本質**:
> ソースファイルの関連情報を可視化し、バグ箇所やリファクタリング影響範囲を特定しやすくする

**Phase 4の正しい方向性**:
> Reactダッシュボード + D3.jsグラフ可視化 + 影響範囲分析API

**現在の誤った実装**:
> phase4_multidb (データベース解析) は補完機能として別に保管

**次のアクション**:
1. 正しいPhase 4仕様書の作成 (PHASE4_VISUALIZATION_SPEC.md)
2. TODOリストの全面見直し
3. phase4_visualizationの実装開始

---

*最終更新: 2025年10月27日*
*バージョン: v1.0.0*
